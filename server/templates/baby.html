<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Baby Statistics</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FullCalendar CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/main.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.10/main.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.10/main.min.css"
      rel="stylesheet"
    />

    <!-- FullCalendar Bundle (includes all plugins) -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

    <!-- Add Tippy.js -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/tippy.js@6/animations/shift-away.css"
    />

    <style>
      .fc-event {
        cursor: pointer;
      }
      .sleep-event {
        background-color: rgb(99, 102, 241) !important;
        border-color: rgb(99, 102, 241) !important;
      }
      .nursing-event {
        background-color: rgb(252, 165, 165) !important;
        border-color: rgb(252, 165, 165) !important;
      }
      .diaper-event {
        background-color: rgb(147, 197, 253) !important;
        border-color: rgb(147, 197, 253) !important;
      }
      .fc .fc-timegrid-slot {
        height: 2.5em;
      }
      .fc .fc-toolbar-title {
        font-size: 1.2em;
      }

      /* Calendar section transition styles */
      #calendarSection {
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: all 0.3s ease-out;
        margin-top: 0;
      }

      #calendarSection.expanded {
        max-height: inherit;
        opacity: 1;
        margin-top: 1rem;
      }

      /* Calendar styles */
      .fc-timegrid-event {
        z-index: 1 !important;
      }

      .fc-timegrid-col-events {
        z-index: 1 !important;
      }

      .fc .fc-popover {
        z-index: 100 !important;
      }

      /* Tooltip styles */
      .tippy-box {
        background-color: white;
        color: #374151;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border-radius: 0.375rem;
        padding: 0.5rem;
        font-size: 0.875rem;
      }

      /* Force tooltips to be rendered at the highest level */
      #calendar {
        position: relative;
      }

      .tippy-box[data-theme~="sleep"],
      .tippy-box[data-theme~="nursing"],
      .tippy-box[data-theme~="diaper"] {
        position: relative;
        z-index: 1000000 !important;
      }

      /* Ensure tooltip container is above calendar events */
      .tippy-box[data-animation="shift-away"][data-state="visible"] {
        z-index: 10000 !important;
      }

      /* Ensure the tooltip backdrop is above calendar events */
      .tippy-box[data-animation="shift-away"][data-state="visible"]
        .tippy-backdrop {
        z-index: 10000 !important;
      }

      /* Make sure the content container is also above calendar */
      .tippy-content {
        z-index: 10000 !important;
        position: relative;
      }

      .tippy-box[data-theme~="sleep"] {
        border-left: 4px solid rgb(99, 102, 241);
      }

      .tippy-box[data-theme~="nursing"] {
        border-left: 4px solid rgb(252, 165, 165);
      }

      .tippy-box[data-theme~="diaper"] {
        border-left: 4px solid rgb(147, 197, 253);
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <nav class="bg-white shadow-lg">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex justify-between h-16">
          <div class="flex items-center">
            <a href="/" class="text-xl font-bold text-indigo-600"
              >Baby Tracker</a
            >
          </div>
          <div class="flex items-center space-x-4">
            <div id="shareSection" class="hidden">
              <button
                onclick="openShareModal()"
                class="text-indigo-600 hover:text-indigo-900"
              >
                Share
              </button>
            </div>
            <button
              id="logoutButton"
              onclick="logout()"
              class="text-gray-600 hover:text-gray-900 hidden"
            >
              Logout
            </button>
          </div>
        </div>
      </div>
    </nav>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
      <div class="px-4 py-6 sm:px-0">
        <h1 class="text-3xl font-bold text-gray-900 mb-8" id="babyName">
          Loading...
        </h1>

        <!-- Date Range Controls -->
        <div class="mb-6 bg-white p-4 rounded-lg shadow">
          <div class="flex items-center space-x-4">
            <div>
              <label
                for="dateRange"
                class="block text-sm font-medium text-gray-700"
                >Date Range</label
              >
              <select
                id="dateRange"
                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
              >
                <option value="7">Last 7 days</option>
                <option value="14">Last 14 days</option>
                <option value="30">Last 30 days</option>
                <option value="custom">Custom Range</option>
              </select>
            </div>
            <div id="customDateInputs" class="hidden space-x-4">
              <div>
                <label
                  for="startDate"
                  class="block text-sm font-medium text-gray-700"
                  >Start Date</label
                >
                <input
                  type="date"
                  id="startDate"
                  class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                />
              </div>
              <div>
                <label
                  for="endDate"
                  class="block text-sm font-medium text-gray-700"
                  >End Date</label
                >
                <input
                  type="date"
                  id="endDate"
                  class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                />
              </div>
            </div>
            <button
              onclick="updateCharts()"
              class="mt-6 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
            >
              Update Charts
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
          <!-- Sleep Chart -->
          <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
              <h3 class="text-lg font-medium text-gray-900">Sleep Hours</h3>
              <div class="mt-4 h-64">
                <canvas id="sleepChart"></canvas>
              </div>
            </div>
          </div>

          <!-- Diaper Chart -->
          <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
              <h3 class="text-lg font-medium text-gray-900">Diaper Changes</h3>
              <div class="mt-4 h-64">
                <canvas id="diaperChart"></canvas>
              </div>
            </div>
          </div>

          <!-- Nursing Chart -->
          <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
              <h3 class="text-lg font-medium text-gray-900">
                Nursing Sessions
              </h3>
              <div class="mt-4 h-64">
                <canvas id="nursingChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Add Calendar View before AI Insights Section -->
        <div class="mt-8 bg-white overflow-hidden shadow rounded-lg">
          <div class="p-5">
            <button
              onclick="toggleCalendar()"
              class="w-full flex justify-between items-center text-left focus:outline-none"
            >
              <h2 class="text-2xl font-bold text-gray-900">Calendar</h2>
              <svg
                id="calendarToggleIcon"
                class="w-6 h-6 transform transition-transform duration-300"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                />
              </svg>
            </button>
            <div id="calendarSection">
              <div class="flex space-x-4 mb-4">
                <div class="flex items-center">
                  <div class="w-4 h-4 bg-indigo-600 rounded mr-2"></div>
                  <span class="text-sm text-gray-600">Sleep</span>
                </div>
                <div class="flex items-center">
                  <div class="w-4 h-4 bg-red-300 rounded mr-2"></div>
                  <span class="text-sm text-gray-600">Nursing</span>
                </div>
                <div class="flex items-center">
                  <div class="w-4 h-4 bg-blue-300 rounded mr-2"></div>
                  <span class="text-sm text-gray-600">Diaper Change</span>
                </div>
              </div>
              <div id="calendar" class="min-h-[600px]"></div>
            </div>
          </div>
        </div>

        <!-- AI Insights Section -->
        <div class="mt-8">
          <h2 class="text-2xl font-bold text-gray-900 mb-4">Insights</h2>
          <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
            <!-- Sleep Patterns -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
              <div class="p-5">
                <h3 class="text-lg font-medium text-gray-900 flex items-center">
                  <svg
                    class="w-5 h-5 mr-2 text-indigo-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                    />
                  </svg>
                  Sleep Patterns
                </h3>
                <div id="sleepInsights" class="mt-4 space-y-3">
                  <div class="animate-pulse">
                    <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                    <div class="space-y-3 mt-4">
                      <div class="h-4 bg-gray-200 rounded"></div>
                      <div class="h-4 bg-gray-200 rounded"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Feeding Patterns -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
              <div class="p-5">
                <h3 class="text-lg font-medium text-gray-900 flex items-center">
                  <svg
                    class="w-5 h-5 mr-2 text-indigo-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  Feeding Patterns
                </h3>
                <div id="feedingInsights" class="mt-4 space-y-3">
                  <div class="animate-pulse">
                    <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                    <div class="space-y-3 mt-4">
                      <div class="h-4 bg-gray-200 rounded"></div>
                      <div class="h-4 bg-gray-200 rounded"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Activity Correlations -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
              <div class="p-5">
                <h3 class="text-lg font-medium text-gray-900 flex items-center">
                  <svg
                    class="w-5 h-5 mr-2 text-indigo-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M13 10V3L4 14h7v7l9-11h-7z"
                    />
                  </svg>
                  Activity Correlations
                </h3>
                <div id="correlationInsights" class="mt-4 space-y-3">
                  <div class="animate-pulse">
                    <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                    <div class="space-y-3 mt-4">
                      <div class="h-4 bg-gray-200 rounded"></div>
                      <div class="h-4 bg-gray-200 rounded"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Pattern Highlights -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
              <div class="p-5">
                <h3 class="text-lg font-medium text-gray-900 flex items-center">
                  <svg
                    class="w-5 h-5 mr-2 text-indigo-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                    />
                  </svg>
                  Pattern Highlights
                </h3>
                <div id="patternHighlights" class="mt-4 space-y-3">
                  <div class="animate-pulse">
                    <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                    <div class="space-y-3 mt-4">
                      <div class="h-4 bg-gray-200 rounded"></div>
                      <div class="h-4 bg-gray-200 rounded"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Share Link Modal -->
        <div
          id="shareModal"
          class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center"
        >
          <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full">
            <h3 class="text-lg font-medium text-gray-900 mb-4">
              Share Baby Statistics
            </h3>
            <div class="mb-4">
              <p class="text-sm text-gray-600 mb-2">
                Enter a custom share link (optional):
              </p>
              <div class="flex items-center space-x-2 mb-4">
                <input
                  type="text"
                  id="customShareToken"
                  placeholder="e.g., baby-emma-stats"
                  class="flex-1 p-2 border rounded"
                />
                <button
                  onclick="generateShareLink()"
                  class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700"
                >
                  Generate
                </button>
              </div>
            </div>
            <div id="shareLinkContainer" class="mb-4 hidden">
              <p class="text-sm text-gray-600 mb-2">
                Share this link with family:
              </p>
              <div class="flex items-center space-x-2">
                <input
                  type="text"
                  id="shareLink"
                  readonly
                  class="flex-1 p-2 border rounded"
                />
                <button
                  onclick="copyShareLink()"
                  class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700"
                >
                  Copy
                </button>
              </div>
            </div>
            <div class="flex justify-end space-x-2">
              <button
                onclick="deleteShareLink()"
                id="deleteShareButton"
                class="text-red-600 hover:text-red-900 px-4 py-2 hidden"
              >
                Delete Share Link
              </button>
              <button
                onclick="closeShareModal()"
                class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      // Check if we're using a share token or regular auth
      const shareToken = window.location.pathname.includes("/share/")
        ? window.location.pathname.split("/share/")[1]
        : null;
      const token = localStorage.getItem("token");
      const babyId = shareToken
        ? null
        : window.location.pathname.split("/").pop();

      if (!shareToken && !token) {
        window.location.href = "/";
      }

      // Show/hide UI elements based on auth method
      if (token) {
        document.getElementById("logoutButton").classList.remove("hidden");
        document.getElementById("shareSection").classList.remove("hidden");
      }

      function logout() {
        localStorage.removeItem("token");
        window.location.href = "/";
      }

      // Share functionality
      function openShareModal() {
        document.getElementById("shareModal").classList.remove("hidden");
      }

      function generateShareLink() {
        const customToken = document.getElementById("customShareToken").value;

        fetch(`/api/baby/${babyId}/share`, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            shareToken: customToken,
          }),
        })
          .then((response) => {
            if (!response.ok) {
              return response.json().then((data) => {
                throw new Error(data.error || "Failed to generate share link");
              });
            }
            return response.json();
          })
          .then((data) => {
            const shareLink = `${window.location.origin}/share/${data.shareToken}`;
            document.getElementById("shareLink").value = shareLink;
            document
              .getElementById("shareLinkContainer")
              .classList.remove("hidden");
            document
              .getElementById("deleteShareButton")
              .classList.remove("hidden");
          })
          .catch((error) => {
            console.error("Error generating share link:", error);
            alert(error.message);
          });
      }

      function deleteShareLink() {
        fetch(`/api/baby/${babyId}/share`, {
          method: "DELETE",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then(() => {
            document
              .getElementById("shareLinkContainer")
              .classList.add("hidden");
            document
              .getElementById("deleteShareButton")
              .classList.add("hidden");
            alert("Share link deleted");
          })
          .catch((error) => {
            console.error("Error deleting share link:", error);
            alert("Error deleting share link");
          });
      }

      function copyShareLink() {
        const shareLink = document.getElementById("shareLink");
        shareLink.select();
        document.execCommand("copy");
        alert("Link copied to clipboard!");
      }

      function closeShareModal() {
        document.getElementById("shareModal").classList.add("hidden");
      }

      // Get date range based on selection
      function getDateRange() {
        const rangeSelect = document.getElementById("dateRange");
        const selectedValue = rangeSelect.value;

        if (selectedValue === "custom") {
          const startDate = document.getElementById("startDate").value;
          const endDate = document.getElementById("endDate").value;
          if (!startDate || !endDate) {
            alert("Please select both start and end dates");
            return null;
          }
          return {
            start: new Date(startDate),
            end: new Date(new Date(endDate).setHours(23, 59, 59, 999)),
          };
        }

        const end = new Date();
        const start = new Date();
        start.setDate(end.getDate() - parseInt(selectedValue));
        return { start, end };
      }

      // Generate array of dates between start and end
      function getDatesArray(start, end) {
        const dates = [];
        const current = new Date(start);
        while (current <= end) {
          dates.push(current.toISOString().split("T")[0]);
          current.setDate(current.getDate() + 1);
        }
        return dates;
      }

      // Show/hide custom date inputs
      document
        .getElementById("dateRange")
        .addEventListener("change", function (e) {
          const customInputs = document.getElementById("customDateInputs");
          customInputs.classList.toggle("hidden", e.target.value !== "custom");
        });

      // Modified fetchData function
      async function fetchData() {
        try {
          const dateRange = getDateRange();
          if (!dateRange) return;

          const headers = token
            ? {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              }
            : { "Content-Type": "application/json" };

          const baseUrl = shareToken ? `/api/public` : `/api`;
          const idParam = shareToken ? shareToken : babyId;

          const [sleepResponse, diaperResponse, nursingResponse, babyResponse] =
            await Promise.all([
              fetch(`${baseUrl}/sleep?babyId=${idParam}`, { headers }),
              fetch(`${baseUrl}/diaper?babyId=${idParam}`, { headers }),
              fetch(`${baseUrl}/nursing?babyId=${idParam}`, { headers }),
              fetch(`${baseUrl}/baby/${idParam}`, { headers }),
            ]);

          // Check for unauthorized responses
          if (
            !shareToken &&
            [sleepResponse, diaperResponse, nursingResponse, babyResponse].some(
              (r) => r.status === 401
            )
          ) {
            localStorage.removeItem("token");
            window.location.href = "/";
            return;
          }

          // Check if baby was found
          if (babyResponse.status === 404) {
            document.getElementById("babyName").textContent = "Baby not found";
            return;
          }

          // Check if all responses are ok
          if (
            ![
              sleepResponse,
              diaperResponse,
              nursingResponse,
              babyResponse,
            ].every((r) => r.ok)
          ) {
            throw new Error("One or more requests failed");
          }

          const [sleepData, diaperData, nursingData, babyData] =
            await Promise.all([
              sleepResponse.json(),
              diaperResponse.json(),
              nursingResponse.json(),
              babyResponse.json(),
            ]);

          // Update baby name
          document.getElementById("babyName").textContent =
            babyData.name + "'s Statistics";

          // Get dates array for the selected range
          const datesArray = getDatesArray(dateRange.start, dateRange.end);

          // Process sleep data
          const sleepHours = datesArray.map((date) => {
            const startOfDay = new Date(date);
            const endOfDay = new Date(date);
            endOfDay.setDate(endOfDay.getDate() + 1);

            return sleepData.reduce((total, sleep) => {
              const sleepStart = new Date(sleep.start);
              const sleepEnd = new Date(sleep.end);

              if (sleepEnd <= startOfDay || sleepStart >= endOfDay) {
                return total;
              }

              const overlapStart =
                sleepStart < startOfDay ? startOfDay : sleepStart;
              const overlapEnd = sleepEnd > endOfDay ? endOfDay : sleepEnd;

              return total + (overlapEnd - overlapStart) / (1000 * 60 * 60);
            }, 0);
          });

          // Update sleep chart
          new Chart(document.getElementById("sleepChart"), {
            type: "line",
            data: {
              labels: datesArray.map((d) => new Date(d).toLocaleDateString()),
              datasets: [
                {
                  label: "Hours of Sleep",
                  data: sleepHours,
                  borderColor: "rgb(99, 102, 241)",
                  tension: 0.1,
                },
              ],
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: "Hours",
                  },
                },
              },
            },
          });

          // Process diaper data
          const diaperCounts = datesArray.map(
            (date) => diaperData.filter((d) => d.time.startsWith(date)).length
          );

          // Update diaper chart
          new Chart(document.getElementById("diaperChart"), {
            type: "bar",
            data: {
              labels: datesArray.map((d) => new Date(d).toLocaleDateString()),
              datasets: [
                {
                  label: "Diaper Changes",
                  data: diaperCounts,
                  backgroundColor: "rgb(147, 197, 253)",
                },
              ],
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    stepSize: 1,
                  },
                },
              },
            },
          });

          // Process nursing data
          const nursingCounts = datesArray.map(
            (date) => nursingData.filter((n) => n.time.startsWith(date)).length
          );

          // Update nursing chart
          new Chart(document.getElementById("nursingChart"), {
            type: "bar",
            data: {
              labels: datesArray.map((d) => new Date(d).toLocaleDateString()),
              datasets: [
                {
                  label: "Nursing Sessions",
                  data: nursingCounts,
                  backgroundColor: "rgb(252, 165, 165)",
                },
              ],
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    stepSize: 1,
                  },
                },
              },
            },
          });

          // Update calendar with the data
          updateCalendar(sleepData, nursingData, diaperData);

          // Add this after the charts are updated
          updateInsights(sleepData, nursingData, diaperData, dateRange);
        } catch (error) {
          console.error("Error fetching data:", error);
          document.getElementById("babyName").textContent =
            "Error loading statistics";
        }
      }

      // Function to update charts
      function updateCharts() {
        // Clear existing charts
        ["sleepChart", "diaperChart", "nursingChart"].forEach((id) => {
          const canvas = document.getElementById(id);
          const chart = Chart.getChart(canvas);
          if (chart) {
            chart.destroy();
          }
        });

        // Fetch new data
        fetchData();
      }

      // Initialize page
      async function initializePage() {
        if (!shareToken && !token) {
          window.location.href = "/";
          return;
        }

        // Set default date range
        const today = new Date();
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(today.getDate() - 7);

        document.getElementById("startDate").value = sevenDaysAgo
          .toISOString()
          .split("T")[0];
        document.getElementById("endDate").value = today
          .toISOString()
          .split("T")[0];

        await fetchData();
      }

      function analyzeSleepPatterns(sleepData, dateRange) {
        const sleepTimes = sleepData.map((sleep) => {
          const start = new Date(sleep.start);
          const end = new Date(sleep.end);
          return {
            startHour:
              ((start.getHours() - 1 + 24) % 24) + start.getMinutes() / 60,
            duration: (end - start) / (1000 * 60 * 60),
            date: start.toISOString().split("T")[0],
          };
        });

        // Find most common sleep start times
        const timeSlots = {};
        sleepTimes.forEach((sleep) => {
          const roundedHour = Math.round(sleep.startHour);
          timeSlots[roundedHour] = (timeSlots[roundedHour] || 0) + 1;
        });

        const bestSleepTimes = Object.entries(timeSlots)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 2)
          .map(([hour]) => formatHour(parseInt(hour)));

        // Calculate average sleep duration
        const avgDuration =
          sleepTimes.reduce((sum, sleep) => sum + sleep.duration, 0) /
          sleepTimes.length;

        // Find longest sleep streak
        const longestSleep = Math.max(
          ...sleepTimes.map((sleep) => sleep.duration)
        );

        return {
          bestTimes: bestSleepTimes,
          avgDuration: avgDuration.toFixed(1),
          longestStreak: longestSleep.toFixed(1),
        };
      }

      function analyzeFeedingPatterns(nursingData) {
        const feedingTimes = nursingData.map((nursing) => {
          const time = new Date(nursing.time);
          return {
            hour: ((time.getHours() - 1 + 24) % 24) + time.getMinutes() / 60,
            date: time.toISOString().split("T")[0],
          };
        });

        // Find most common feeding times
        const timeSlots = {};
        feedingTimes.forEach((feeding) => {
          const roundedHour = Math.round(feeding.hour);
          timeSlots[roundedHour] = (timeSlots[roundedHour] || 0) + 1;
        });

        const commonFeedingTimes = Object.entries(timeSlots)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 3)
          .map(([hour]) => formatHour(parseInt(hour)));

        // Calculate average feedings per day
        const dates = [...new Set(feedingTimes.map((f) => f.date))];
        const avgFeedingsPerDay = feedingTimes.length / dates.length;

        return {
          commonTimes: commonFeedingTimes,
          avgPerDay: avgFeedingsPerDay.toFixed(1),
        };
      }

      function findActivityCorrelations(sleepData, nursingData, diaperData) {
        // Convert all activities to a timeline with timestamps
        const activities = [
          ...sleepData.map((s) => ({
            type: "sleep",
            time: new Date(s.start).getTime(),
            endTime: new Date(s.end).getTime(),
            hour: (new Date(s.start).getHours() - 1 + 24) % 24,
            date: new Date(s.start).toISOString().split("T")[0],
          })),
          ...nursingData.map((n) => ({
            type: "nursing",
            time: new Date(n.time).getTime(),
            hour: (new Date(n.time).getHours() - 1 + 24) % 24,
            date: new Date(n.time).toISOString().split("T")[0],
          })),
          ...diaperData.map((d) => ({
            type: "diaper",
            time: new Date(d.time).getTime(),
            hour: (new Date(d.time).getHours() - 1 + 24) % 24,
            date: new Date(d.time).toISOString().split("T")[0],
          })),
        ].sort((a, b) => a.time - b.time);

        // Initialize pattern tracking
        const patterns = {
          "sleep-after-nursing": { count: 0, total: 0, avgMinutes: 0 },
          "diaper-after-nursing": { count: 0, total: 0, avgMinutes: 0 },
          "nursing-after-sleep": { count: 0, total: 0, avgMinutes: 0 },
          "diaper-after-sleep": { count: 0, total: 0, avgMinutes: 0 },
        };

        // Analyze patterns within a reasonable time window (3 hours)
        const TIME_WINDOW = 3 * 60 * 60 * 1000; // 3 hours in milliseconds

        activities.forEach((current, i) => {
          if (i === 0) return;

          const prev = activities[i - 1];
          const timeDiff = current.time - prev.time;

          // Only consider activities within the time window
          if (timeDiff > TIME_WINDOW) return;

          const pattern = `${current.type}-after-${prev.type}`;
          if (patterns.hasOwnProperty(pattern)) {
            patterns[pattern].count++;
            patterns[pattern].total++;
            patterns[pattern].avgMinutes = timeDiff / (60 * 1000);
          }
        });

        // Find significant patterns
        const significantPatterns = Object.entries(patterns)
          .filter(([_, data]) => data.count > 0)
          .sort((a, b) => b[1].count - a[1].count)
          .map(([pattern, data]) => {
            const [action, _, trigger] = pattern.split("-");
            const avgMinutes = Math.round(data.avgMinutes / data.count);

            // Format the correlation message
            if (avgMinutes < 60) {
              return `${trigger} is often followed by ${action} within ${avgMinutes} minutes`;
            } else {
              const hours = Math.floor(avgMinutes / 60);
              const mins = avgMinutes % 60;
              return `${trigger} is often followed by ${action} within ${hours}h ${mins}m`;
            }
          })
          .slice(0, 2); // Get top 2 most significant patterns

        return significantPatterns.length > 0
          ? significantPatterns
          : ["No significant patterns detected yet"];
      }

      function findPatternHighlights(sleepData, nursingData, diaperData) {
        const highlights = [];

        // Analyze sleep consistency
        const sleepStarts = sleepData.map((s) => new Date(s.start).getHours());
        const sleepEnds = sleepData.map((s) => new Date(s.end).getHours());

        // Calculate sleep consistency score (0-100%)
        const startVariance = calculateVariance(sleepStarts);
        const endVariance = calculateVariance(sleepEnds);
        const consistencyScore = Math.round(
          (1 - (startVariance + endVariance) / 48) * 100
        );

        if (consistencyScore > 70) {
          highlights.push(
            `Very consistent schedule (${consistencyScore}% regular)`
          );
        }

        // Find longest sleep period
        const sleepDurations = sleepData.map((s) => {
          const start = new Date(s.start);
          const end = new Date(s.end);
          return (end - start) / (1000 * 60 * 60);
        });
        const maxSleep = Math.max(...sleepDurations);
        if (maxSleep > 6) {
          highlights.push(`Achieved ${maxSleep.toFixed(1)} hour sleep session`);
        }

        // Analyze feeding patterns
        const feedingHours = nursingData.map((n) =>
          new Date(n.time).getHours()
        );
        const feedingClusters = findTimeClusters(feedingHours);
        if (feedingClusters.length > 0) {
          highlights.push(
            `Regular feeding clusters at ${feedingClusters
              .map((h) => formatHour(h))
              .join(" and ")}`
          );
        }

        // Find quiet periods (no activities)
        const allActivities = [
          ...sleepData.map((s) => ({
            time: new Date(s.start).getHours(),
            type: "sleep",
          })),
          ...nursingData.map((n) => ({
            time: new Date(n.time).getHours(),
            type: "nursing",
          })),
          ...diaperData.map((d) => ({
            time: new Date(d.time).getHours(),
            type: "diaper",
          })),
        ];

        const quietHours = findQuietHours(allActivities);
        if (quietHours.length > 0) {
          highlights.push(
            `Typically calm between ${formatHour(quietHours[0])} - ${formatHour(
              quietHours[1]
            )}`
          );
        }

        return highlights;
      }

      function calculateVariance(numbers) {
        const mean = numbers.reduce((a, b) => a + b, 0) / numbers.length;
        return (
          numbers.reduce((a, b) => a + Math.pow(b - mean, 2), 0) /
          numbers.length
        );
      }

      function findTimeClusters(hours) {
        const frequency = new Array(24).fill(0);
        hours.forEach((h) => frequency[h]++);

        return frequency
          .map((count, hour) => ({ hour, count }))
          .filter(({ count }) => count > hours.length * 0.15)
          .map(({ hour }) => hour);
      }

      function findQuietHours(activities) {
        const frequency = new Array(24).fill(0);
        activities.forEach((a) => frequency[a.time]++);

        let longestQuiet = { start: 0, length: 0 };
        let currentQuiet = { start: 0, length: 0 };

        for (let i = 0; i < 48; i++) {
          const hour = i % 24;
          if (frequency[hour] <= 1) {
            if (currentQuiet.length === 0) {
              currentQuiet.start = hour;
            }
            currentQuiet.length++;
          } else {
            if (currentQuiet.length > longestQuiet.length) {
              longestQuiet = { ...currentQuiet };
            }
            currentQuiet = { start: 0, length: 0 };
          }
        }

        return [
          longestQuiet.start,
          (longestQuiet.start + longestQuiet.length) % 24,
        ];
      }

      function formatHour(hour) {
        // Ensure hour is between 0-23
        hour = (hour + 24) % 24;
        // Format as HH:00
        return `${hour.toString().padStart(2, "0")}:00`;
      }

      function updateInsights(sleepData, nursingData, diaperData, dateRange) {
        // Analyze sleep patterns
        const sleepPatterns = analyzeSleepPatterns(sleepData, dateRange);
        document.getElementById("sleepInsights").innerHTML = `
          <p class="text-gray-600">Best sleep times appear to be around ${sleepPatterns.bestTimes.join(
            " and "
          )}.</p>
          <p class="text-gray-600">Average sleep duration: ${
            sleepPatterns.avgDuration
          } hours</p>
          <p class="text-gray-600">Longest sleep streak: ${
            sleepPatterns.longestStreak
          } hours</p>
        `;

        // Analyze feeding patterns
        const feedingPatterns = analyzeFeedingPatterns(nursingData);
        document.getElementById("feedingInsights").innerHTML = `
          <p class="text-gray-600">Most common feeding times: ${feedingPatterns.commonTimes.join(
            ", "
          )}</p>
          <p class="text-gray-600">Average feedings per day: ${
            feedingPatterns.avgPerDay
          }</p>
        `;

        // Find correlations
        const correlations = findActivityCorrelations(
          sleepData,
          nursingData,
          diaperData
        );
        document.getElementById("correlationInsights").innerHTML = `
          <p class="text-gray-600">Pattern detected:</p>
          <ul class="list-disc list-inside text-gray-600">
            ${correlations.map((corr) => `<li>${corr}</li>`).join("")}
          </ul>
        `;

        // Update pattern highlights instead of routine summary
        const highlights = findPatternHighlights(
          sleepData,
          nursingData,
          diaperData
        );
        document.getElementById("patternHighlights").innerHTML = `
          <div class="space-y-2">
            ${highlights
              .map(
                (highlight) => `
              <div class="flex items-center text-gray-600">
                <svg class="w-4 h-4 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                ${highlight}
              </div>
            `
              )
              .join("")}
          </div>
        `;
      }

      function toggleCalendar() {
        const calendarSection = document.getElementById("calendarSection");
        const toggleIcon = document.getElementById("calendarToggleIcon");
        const isExpanded = calendarSection.classList.contains("expanded");

        if (!isExpanded) {
          calendarSection.classList.add("expanded");
          toggleIcon.style.transform = "rotate(180deg)";
          // Re-render calendar when showing to ensure proper sizing
          setTimeout(() => {
            if (window.currentCalendar) {
              window.currentCalendar.render();
            }
          }, 300);
        } else {
          calendarSection.classList.remove("expanded");
          toggleIcon.style.transform = "rotate(0deg)";
        }
      }

      function updateCalendar(sleepData, nursingData, diaperData) {
        const calendarEl = document.getElementById("calendar");

        // Destroy existing calendar instance if it exists
        if (window.currentCalendar) {
          window.currentCalendar.destroy();
        }

        // Convert data to calendar events
        const events = [
          ...sleepData.map((sleep) => ({
            title: "Sleep",
            start: sleep.start,
            end: sleep.end,
            classNames: ["sleep-event"],
            extendedProps: {
              type: "sleep",
              duration: `${(
                (new Date(sleep.end) - new Date(sleep.start)) /
                (1000 * 60 * 60)
              ).toFixed(1)} hours`,
            },
          })),
          ...nursingData.map((nursing) => ({
            title: "Nursing",
            start: nursing.time,
            end: new Date(new Date(nursing.time).getTime() + 15 * 60000),
            classNames: ["nursing-event"],
            extendedProps: {
              type: "nursing",
            },
          })),
          ...diaperData.map((diaper) => ({
            title: "Diaper Change",
            start: diaper.time,
            end: new Date(new Date(diaper.time).getTime() + 15 * 60000),
            classNames: ["diaper-event"],
            extendedProps: {
              type: "diaper",
              details: diaper.type,
            },
          })),
        ];

        // Initialize calendar
        window.currentCalendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "timeGridWeek",
          headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: "dayGridMonth,timeGridWeek,timeGridDay",
          },
          slotMinTime: "06:00:00",
          slotMaxTime: "23:00:00",
          height: "auto",
          events: events,
          eventDidMount: function (info) {
            let content = "";
            const startTime = info.event.start.toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
              hour12: false,
            });

            switch (info.event.extendedProps.type) {
              case "sleep":
                content = `
                  <div class="font-medium">${info.event.title}</div>
                  <div>Start: ${startTime}</div>
                  <div>Duration: ${info.event.extendedProps.duration}</div>
                `;
                break;
              case "nursing":
                content = `
                  <div class="font-medium">${info.event.title}</div>
                  <div>Time: ${startTime}</div>
                `;
                break;
              case "diaper":
                content = `
                  <div class="font-medium">${info.event.title}</div>
                  <div>Time: ${startTime}</div>
                  <div>Type: ${info.event.extendedProps.details}</div>
                `;
                break;
            }

            tippy(info.el, {
              content: content,
              allowHTML: true,
              theme: info.event.extendedProps.type,
              placement: "top",
              animation: "shift-away",
              interactive: true,
              appendTo: document.body,
              zIndex: 1000000,
              popperOptions: {
                modifiers: [
                  {
                    name: "preventOverflow",
                    options: {
                      boundary: "viewport",
                    },
                  },
                  {
                    name: "flip",
                    options: {
                      fallbackPlacements: ["bottom", "right", "left"],
                    },
                  },
                ],
              },
            });
          },
          nowIndicator: true,
          scrollTime: "07:00:00",
          slotDuration: "00:30:00",
          allDaySlot: false,
          slotLabelFormat: {
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
          },
          eventTimeFormat: {
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
          },
          dayHeaderFormat: {
            weekday: "short",
            month: "numeric",
            day: "numeric",
          },
        });

        window.currentCalendar.render();
      }

      initializePage();
    </script>
  </body>
</html>
