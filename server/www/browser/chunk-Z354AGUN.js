import{Fa as h,Ga as p,Ha as f,m as l}from"./chunk-SHX6CIJO.js";import{R as d,W as c,f as u}from"./chunk-DMKK32ZK.js";import{c as o}from"./chunk-IPDSYFFT.js";import{f as a}from"./chunk-RW4GY4BD.js";var b=(()=>{let r=class r{constructor(t,e){this.router=t,this.headersService=e,this.isAuthenticated=new u(!1),this.baseUrl=h.apiUrl.replace("/api","")}validateToken(t){return a(this,null,function*(){try{return(yield o.get({url:`${h.apiUrl}/baby`,headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}})).status===200}catch(e){return console.error("Token validation failed:",e),!1}})}checkAuthentication(){return a(this,null,function*(){let t=yield this.headersService.getStoredToken();if(t){if(yield this.validateToken(t))return this.isAuthenticated.next(!0),!0;yield this.headersService.removeToken()}try{return yield this.autoLogin(),!0}catch(e){return console.error("Auto-login failed:",e),this.router.navigate(["/register"]),!1}})}autoLogin(){return a(this,null,function*(){let e=`user_${(yield p.getId()).identifier}`,i="changeme123";try{yield this.login(e,i)}catch{yield this.register(e,i)}})}login(t,e){return a(this,null,function*(){let i=yield o.post({url:`${this.baseUrl}/auth/login`,headers:{"Content-Type":"application/json"},data:{username:t,password:e}});if(i.status===200){let s=i.data;yield this.headersService.setToken(s.token),this.isAuthenticated.next(!0)}else throw new Error("Login failed")})}register(t,e){return a(this,null,function*(){let i=yield o.post({url:`${this.baseUrl}/auth/register`,headers:{"Content-Type":"application/json"},data:{username:t,password:e}});if(i.status===200){let s=i.data;yield this.headersService.setToken(s.token),this.isAuthenticated.next(!0)}else throw new Error("Registration failed")})}logout(){return a(this,null,function*(){yield this.headersService.removeToken(),this.isAuthenticated.next(!1),this.router.navigate(["/login"])})}isAuthenticatedState(){return this.isAuthenticated.asObservable()}};r.\u0275fac=function(e){return new(e||r)(c(l),c(f))},r.\u0275prov=d({token:r,factory:r.\u0275fac,providedIn:"root"});let n=r;return n})();export{b as a};
