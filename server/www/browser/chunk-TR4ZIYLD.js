import{a as x}from"./chunk-2AT3FX7A.js";import{Ea as y,Fa as v,Ha as T,xa as g}from"./chunk-SHX6CIJO.js";import{R as S,Rb as w,Tb as b,X as p,pa as c}from"./chunk-DMKK32ZK.js";import{c as o}from"./chunk-IPDSYFFT.js";import{a as f,b as m,f as a}from"./chunk-RW4GY4BD.js";var H=()=>$(new Date),l=h=>h.toLocaleString("da-DK",{hour:"2-digit",minute:"2-digit"});var $=h=>{let d=h.getTimezoneOffset();return h.setMinutes(h.getMinutes()-d),h};var k=(()=>{let d=class d{compareDates(t,e){return typeof t=="string"&&(t=new Date(t)),typeof e=="string"&&(e=new Date(e)),t.toISOString().split("T")[0]===e.toISOString().split("T")[0]}constructor(){this.toastController=p(g),this.babyService=p(x),this.headersService=p(T),this.totalHoursSlept=c(0),this.apiUrl=v.apiUrl,this.sleeps=c([]),this.diapers=c([]),this.nursings=c([]),this.totalDiapersToday=w(()=>{let t=this.diapers();return Array.isArray(t)?t.filter(e=>this.compareDates(e.time,new Date)).map((e,r)=>m(f({},e),{id:e.id||`today-${r}`})):[]}),this.totalNursingsToday=w(()=>{let t=this.nursings();return Array.isArray(t)?t.filter(e=>this.compareDates(e.time,new Date)).map((e,r)=>m(f({},e),{id:e.id||`today-${r}`})):[]}),this.sleepArrayFromTotalHoursSlept=w(()=>{this.sleeps(),this.refreshTotalHoursSlept().catch(()=>{});let t=this.totalHoursSlept(),e=[];for(let r=0;r<t;r++)e.push({type:t-r<1?"half":"full",id:`sleep-${r}`});return e}),b(()=>{this.sleeps(),this.refreshTotalHoursSlept().catch(()=>{})})}saveLastTimer(t){y.set({key:"lastTimer",value:t.toISOString()})}getLastTimer(){return a(this,null,function*(){let t=yield y.get({key:"lastTimer"});return this.removeLastTimer(),t})}removeLastTimer(){return a(this,null,function*(){yield y.remove({key:"lastTimer"})})}refresh(){return a(this,null,function*(){let t=this.babyService.activeBaby();if(!t){this.sleeps.set([]),this.diapers.set([]),this.nursings.set([]);return}let e=new Date().toISOString().split("T")[0];try{let r=yield o.get({url:`${this.apiUrl}/report/${t.id}/history/${e}`,headers:yield this.headersService.getHeaders()});r.data?(this.sleeps.set(r.data.sleeps||[]),this.diapers.set(r.data.diapers||[]),this.nursings.set(r.data.nursings||[])):(this.sleeps.set([]),this.diapers.set([]),this.nursings.set([]))}catch(r){throw console.error("Failed to refresh data:",r),this.sleeps.set([]),this.diapers.set([]),this.nursings.set([]),yield this.showToast("Failed to refresh data"),r}})}refreshTotalHoursSlept(){return a(this,null,function*(){let t=this.babyService.activeBaby();if(!t){this.totalHoursSlept.set(0);return}let e=new Date().toISOString().split("T")[0];try{let r=yield o.get({url:`${this.apiUrl}/report/${t.id}/history/${e}`,headers:yield this.headersService.getHeaders()});if(r.data&&Array.isArray(r.data.sleeps)){let i=r.data.sleeps.reduce((n,s)=>n+(new Date(s.end).getTime()-new Date(s.start).getTime())/36e5,0);this.totalHoursSlept.set(i)}else this.totalHoursSlept.set(0)}catch(r){console.error("Failed to refresh total hours slept:",r),this.totalHoursSlept.set(0)}})}getTotalHoursSleptForDate(t,e){return a(this,null,function*(){var i,n;if(e||(e=(i=this.babyService.activeBaby())==null?void 0:i.id),!e)return 0;let r=t!=null?t:new Date().toISOString().split("T")[0].replace(/-/g,"/");try{return(n=(yield o.get({url:`${this.apiUrl}/sleep/${e}/date/${r}`,headers:yield this.headersService.getHeaders()})).data.totalHoursSlept)!=null?n:0}catch(s){return console.error("Failed to get total hours slept:",s),0}})}addSleep(t,e="My"){return a(this,null,function*(){var r,i;if(t.babyId=(i=t.babyId)!=null?i:(r=this.babyService.activeBaby())==null?void 0:r.id,!t.babyId)throw yield this.showToast("No active baby selected"),new Error("No active baby selected");try{let s=(yield o.post({url:`${this.apiUrl}/sleep`,headers:yield this.headersService.getHeaders(),data:t})).data;this.sleeps.update(u=>[...u!=null?u:[],s]),yield this.showToast(`Added ${e} sleep from ${l(t.start)} to ${l(t.end)}`)}catch(n){throw yield this.showToast("Failed to add sleep record"),n}})}deleteSleep(t){return a(this,null,function*(){try{yield o.delete({url:`${this.apiUrl}/sleep/${t}`,headers:yield this.headersService.getHeaders()}),this.sleeps.update(e=>e.filter(r=>r.id!==t))}catch(e){throw yield this.showToast("Failed to delete sleep record"),e}})}addDiaper(t){return a(this,null,function*(){var e,r;if(t.babyId=(r=t.babyId)!=null?r:(e=this.babyService.activeBaby())==null?void 0:e.id,!t.babyId)throw yield this.showToast("No active baby selected"),new Error("No active baby selected");try{let n=(yield o.post({url:`${this.apiUrl}/diaper`,headers:yield this.headersService.getHeaders(),data:t})).data;this.diapers.update(s=>[...s!=null?s:[],n]),yield this.showToast(`Added diaper: type: ${t.type}, time: ${l(t.time)}`)}catch(i){throw yield this.showToast("Failed to add diaper record"),i}})}editSleep(t){return a(this,null,function*(){try{yield o.put({url:`${this.apiUrl}/sleep/${t.id}`,headers:yield this.headersService.getHeaders(),data:t}),yield this.refresh()}catch(e){throw yield this.showToast("Failed to edit sleep record"),e}})}editDiaper(t){return a(this,null,function*(){try{yield o.put({url:`${this.apiUrl}/diaper/${t.id}`,headers:yield this.headersService.getHeaders(),data:t}),yield this.refresh()}catch(e){throw yield this.showToast("Failed to edit diaper record"),e}})}editNursing(t){return a(this,null,function*(){try{yield o.put({url:`${this.apiUrl}/nursing/${t.id}`,headers:yield this.headersService.getHeaders(),data:t}),yield this.refresh()}catch(e){throw yield this.showToast("Failed to edit nursing record"),e}})}deleteDiaper(t){return a(this,null,function*(){try{yield o.delete({url:`${this.apiUrl}/diaper/${t}`,headers:yield this.headersService.getHeaders()}),this.diapers.update(e=>e.filter(r=>r.id!==t)),yield this.refresh()}catch(e){throw yield this.showToast("Failed to delete diaper record"),e}})}addNursing(t){return a(this,null,function*(){var e,r;if(t.babyId=(r=t.babyId)!=null?r:(e=this.babyService.activeBaby())==null?void 0:e.id,!t.babyId)throw yield this.showToast("No active baby selected"),new Error("No active baby selected");try{let n=(yield o.post({url:`${this.apiUrl}/nursing`,headers:yield this.headersService.getHeaders(),data:t})).data;this.nursings.update(s=>[...s!=null?s:[],n]),yield this.showToast(`Added nursing: ${t.amount} ${t.type}, time: ${l(t.time)}`)}catch(i){throw yield this.showToast("Failed to add nursing record"),i}})}deleteNursing(t){return a(this,null,function*(){try{yield o.delete({url:`${this.apiUrl}/nursing/${t}`,headers:yield this.headersService.getHeaders()}),this.nursings.update(e=>e.filter(r=>r.id!==t))}catch(e){throw yield this.showToast("Failed to delete nursing record"),e}})}showToast(t){return a(this,null,function*(){yield(yield this.toastController.create({message:t,duration:2e3,position:"bottom"})).present()})}};d.\u0275fac=function(e){return new(e||d)},d.\u0275prov=S({token:d,factory:d.\u0275fac,providedIn:"root"});let h=d;return h})();export{H as a,k as b};
